[gcode_macro PWM_SOAK]
variable_goal: 30
variable_pwm: 0
variable_tests: 0
variable_left: 30
gcode:
    SAVE_GCODE_STATE NAME=STATE_PWM_SOAK
    {% set goal = params.GOAL|default(30) %}
    SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=left VALUE=30
    {% set pwm = printer['heater_bed'].power | float %}
    SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=pwm VALUE={pwm}
    SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=tests VALUE=1
    {action_respond_info("Preheat bed to %d%% PWM" % (goal)|int)}
    M117 {'T:%02d' % left|int}{'/30 P:%.2f' % (pwm*100)|float}{'/%d' % (goal|int)}
    BASE_PAUSE
    UPDATE_DELAYED_GCODE ID=PWM_WAIT DURATION=1

[delayed_gcode PWM_WAIT]
gcode:
    {% set goal = (printer["gcode_macro PWM_SOAK"].goal|int)|float %}
    {% set pwm = printer['heater_bed'].power | float %}
    {% set totalpwm = printer["gcode_macro PWM_SOAK"].pwm|float%}
    {% set tests = printer["gcode_macro PWM_SOAK"].tests|int + 1 %}
    {% set left = printer["gcode_macro PWM_SOAK"].left|int - 1 %}
    {% set avgpwm = ((totalpwm+pwm)/tests)|float %}
    M117 {'T:%02d' % left|int}{'/30 P:%.2f' % (avgpwm*100|int)}{'/%d' % (goal|int)}
    SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=pwm VALUE={(totalpwm+pwm)|float}
    SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=tests VALUE={tests}
    SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=left VALUE={left}
    {% if left == 0 %}
        {% if avgpwm > (goal/100)|float %}
            SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=pwm VALUE=0
            SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=tests VALUE=0
            SET_GCODE_VARIABLE MACRO=PWM_SOAK VARIABLE=left VALUE=30
            UPDATE_DELAYED_GCODE ID=PWM_WAIT DURATION=1
        {% else %}
            {action_respond_info("Done. Mean PWM: %f" % (avgpwm*100|float))}
            UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=1
        {% endif %}
    {% else %}
        {% if avgpwm > (goal/100)|float %}
            UPDATE_DELAYED_GCODE ID=PWM_WAIT DURATION=1
        {% else %}
            {action_respond_info("Done. Mean PWM: %f" % (avgpwm*100|float))}
            UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=1
            RESTORE_GCODE_STATE NAME=STATE_PWM_SOAK
            BASE_RESUME
        {% endif %}
    {% endif %}